#!/bin/sh
# Query utility for z/OS Open Tools - https://github.com/ZOSOpenTools

export utildir="$( cd "$(dirname "$0")" >/dev/null 2>&1 && pwd -P )"

. "${utildir}/common.inc"

printSyntax() 
{
  args=$*
  echo "zopen query is a utility for z/OS Open Tools to query packages and repos." >&2
  echo "Syntax: zopen-query [<option>]* [<package]*" >&2
  echo "  where <option> may be one or more of:" >&2
  echo "  --list: list all available z/OS Open Tools."  >&2
  echo "  --remote-search: check for package in z/OS Open Tools repo" >&2
  echo "  -i : --installed: list install z/OS Open Tools." >&2
  echo " --upgradeable: list packages where an upgrade is available." >&2
#TODO echo "  --provides: list the files that an installed package provides." >&2
  echo "  -wp : --whatprovides: which installed package provided a file." >&2
  echo "  -v: run in verbose mode." >&2
  echo "  -d | --details: include full details for listings." >&2
  echo "  --no-header: suppress the header for the output." >&2
  echo "  --no-version:  suppress version information, return package names." >&2
  echo "  --filter <color>: apply filter based on quality (green - all tests passing, blue - most tests passing, yellow - some tests passing, red - no tests passing, or skipped (no filter by default))"  >&2
  echo " and <package> is an optional list of one or more packages." >&2
}

printDetailListEntries()
{
  details=$1
  needle=$2
  onlyUpgradesAvailable=$3

  if [ $details -eq 0 ]; then
    scrcols=$(getScreenCols)
    numcols=4
    colwidth=$(($scrcols / $numcols -1 ))
    if [ ! -z "$1" ] && ! $noheader; then
      printf "${NC}${UNDERLINE}%-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s\n${NC}" "Package" "Installed" "Available" "Latest Tag"
    fi
    echo "$repoArray" | xargs | tr ' ' '\n' | sort | while read repo; do
      if [ -z $needle ] || [ "${repo}" = "${needle}" ]; then
        latest=$(jq -e -r '.release_data."'$repo'"[0]' "$JSON_CACHE")
        if [ $? -ne 0 ]; then
          printError "Unable to retrieve remote information"
        fi
        latestTag=$(/bin/printf "%s" "$latest" | jq -e -r '.tag_name')
        if [ -e "${ZOPEN_PKGINSTALL}/${repo}/.releaseinfo" ]; then
          originalTag=$(cat "${ZOPEN_PKGINSTALL}/${repo}/.releaseinfo")
        else
          originalTag="Not installed"
        fi
        if [ -e "${ZOPEN_PKGINSTALL}/${repo}/.version" ]; then
          dotversion=$(cat "${ZOPEN_PKGINSTALL}/${repo}/.version")
        else
          dotversion="N/A"
        fi
        if [ $onlyUpgradesAvailable -gt 0 ]; then
          if [ "$originalTag" = "Not installed" -o "$originalTag" = "$latestTag" ]; then
            continue;
          fi 
        fi
        if ! $noversions; then
          printf "%-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s\n" "$repo" "$originalTag" "$dotversion" "$latestTag"
        else
          printf "%s\n" "$repo"
        fi
      fi 
    done
  else
    printVerbose "Checking repoArray: $repoArray"
    scrcols=$(getScreenCols)
    numcols=6
    colwidth=$(($scrcols / $numcols -1 ))
    if ! $noheader; then
      printf "${NC}${UNDERLINE}%-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s\n${NC}" "Package" "Your version" "Latest Tag" "Download Size" "Expanded Size" "Quality"
    fi
    echo "$repoArray" | xargs | tr ' ' '\n' | sort | while read repo; do
      if [ -z $needle ] || [ "${repo}" = "${needle}" ]; then
        if [ -e "${ZOPEN_PKGINSTALL}/${repo}/.releaseinfo" ]; then
          originalTag=$(cat "${ZOPEN_PKGINSTALL}/${repo}/.releaseinfo")
        else
          originalTag="Not installed"
        fi
        latest=$(jq -e -r '.release_data."'$repo'"[0]' "$JSON_CACHE")
        case $? in
          1) printVerbose "No latest release for port";
               printf "%-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s ${NC}${RED}%-${colwidth}s${NC}\n" "$repo" "$originalTag" "Unknown" "Unknown" "Unknown" "Unknown" 
               ;;
          0) printVerbose "Latest release request successful";  
               latestTag="$(/bin/printf "%s" "$latest" | jq -e -r '.tag_name')"
               passed="$(/bin/printf "%s" "$latest" | jq -e -r '.assets[0].passed_tests')"
               total="$(/bin/printf "%s" "$latest" | jq -e -r '.assets[0].total_tests')"
               expandedsize="$(/bin/printf "%s" "$latest" | jq -e -r '.assets[0].expanded_size')"
               downloadsize="$(/bin/printf "%s" "$latest" | jq -e -r '.assets[0].size')"
               if [ $onlyUpgradesAvailable -gt 0 ]; then
                 if [ "$originalTag" = "Not installed" -o "$originalTag" = "$latestTag" ]; then
                   continue;
                 fi 
               fi
               if [ $total -gt 0 ]; then
                 percentage=$(echo "scale=0; 100 * ($passed) / $total" | bc)
               fi
               printf "%-${colwidth}s %-${colwidth}s %-${colwidth}s " "$repo" "$originalTag" "$latestTag" 
               if [ -z "$percentage" ]; then
                printf "${NC}${RED}%-${colwidth}s${NC}" "No tests"
               elif [ $percentage -eq 100 ]; then
                printf "${NC}${GREEN}%-${colwidth}s${NC}" "$percentage%"
               elif [ $percentage -gt 50 ]; then
                printf "${NC}${BLUE}%-${colwidth}s${NC}" "$percentage%"
               elif [ $percentage -gt 0 ]; then
                printf "${NC}${YELLOW}%-${colwidth}s${NC}" "$percentage%"
               else
                printf "${NC}${RED}%-${colwidth}s${NC}" "$percentage%"
               fi
               printf " %-${colwidth}s"  "$expandedsize"
               printf " %-${colwidth}s"  "$downloadsize"
               printf "\n"
               ;;
          *) printError "Error $httpResponseCode while trying to retrieve latest repo release";;
        esac

      fi
      continue;   
    done
  fi
  exit 0
}
printInstalledEntries(){
  scrcols=$(getScreenCols)
  numcols=4
  colwidth=$(($scrcols / $numcols -1 ))
  printVerbose "Screen width: $scrcols; colwidth:$colwidth"
  if [ ! -z "$1" ] && ! $noheader; then
    printf "${NC}${UNDERLINE}%-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s\n${NC}" "Package" "Installed" "File" "Releaseline"
  fi
  printVerbose "Getting list of symlinks in the package install directory (that point to specific versions)"
  installedPackages=$(zosfind . -type d \! -name . -prune -o -type l -print)
  printVerbose "Packages: $installedPackages"
  echo "$installedPackages" | xargs | tr ' ' '\n' | sort | while read repo; do
    pkghome="$ZOPEN_PKGINSTALL/${repo}"
    if [ ! -e "${pkghome}/.active" ]; then
      printVerbose "Symlink '$repo' in '$ZOPEN_PKGINSTALL' is not active; skipping"
      continue
    fi

    reponame=$(echo "${repo#./}") 
    if $noversions; then
      printf "%s\n" "$reponame"
      continue
    fi

    if [ -e "${pkghome}/.releaseinfo" ]; then
      originalTag=$(cat "${pkghome}/.releaseinfo")
    else
      originalTag="N/A"
    fi
    if [ -e "${pkghome}/.version" ]; then
      dotversion=$(cat "${pkghome}/.version")
    else
      dotversion="N/A"
    fi

    if [ -e "${pkghome}/.releaseline" ]; then
      releaseline=$(cat "${pkghome}/.releaseline")
    else
      releaseline="N/A"
    fi

    printVerbose "Original tag: $originalTag for repo: $repo"
    if [ -z "$1" ]; then
      printInfo "$originalTag"
    else
      fileversion="$( cd "$ZOPEN_PKGINSTALL/${repo}" >/dev/null 2>&1 && pwd -P | xargs basename)"
      printf "%-${colwidth}s %-${colwidth}s %-${colwidth}s %-${colwidth}s\n" "$reponame" "$dotversion" "$fileversion" "$releaseline"
    fi
  done
  exit 0
}


whatProvides(){
  needle=$1
  printVerbose "Finding matches outside the ZOPEN_PKGINSTALL ($ZOPEN_PKGINSTALL)"
  # Find any symlinks that match the name and can then be dereferenced
  found=$(zosfind $ZOPEN_ROOTFS/usr -type l | grep "${needle}")
  printVerbose "Found? '$found'"
  if [[ -z $found ]]; then
    printInfo "No package provides '${needle}'"
  else
    matches=$(echo "$found"| wc -w | tr -d ' ' ) 
    printInfo "Found ${matches} match$([ $matches = 1 ] && echo "" || echo "es") for regex '${needle}' on the system"
    echo "$found" | xargs | tr ' ' '\n' | while read foundmatch; do
      printVerbose "Parsing $foundmatch"
      if [ ! -d $foundmatch ]; then
        deref=$(ls -l $foundmatch | awk '{ print $(NF) }')
        printVerbose "$ZOPEN_PKGINSTALL  -> $deref"
        printVerbose "${deref#$ZOPEN_PKGINSTALL}"
        pkg=$(echo "${deref#$ZOPEN_PKGINSTALL}" | awk -F/ '{print $2}')
        printInfo "$pkg provides '$foundmatch'"
      fi
    done
  fi
  exit 0
}

# Main code start here
args=$*
verbose=false
noheader=false
noversions=false
localoption=true
upgradeable=false
details=0
needle=
if [[ $# -eq 0 ]]; then
  printError "No option provided for query"
fi

while [[ $# -gt 0 ]]; do
  printVerbose "Parsing option: $1"
  case "$1" in
    "--list")
      list=1;
      localoption=false;
      ;;
    "-i" | "--installed")
      localoption=true;
      installed=1;
      list=;
    ;;
    "-wp" | "--whatprovides")
      localoption=true;
      whatprovides=1;
      shift;
      [ ! -z $1 ] || printError "Missing file argument";
      needle=$1;
    ;;
    "--remote-search")
      localoption=false;
      remotesearch=1;
      shift;
      [ ! -z $1 ] || printError "Missing package argument";
      needle=$1;
    ;;
    "--no-header")
      noheader=true;
    ;;
    "--upgradeable")
      upgradeable=true;
    ;;
    "--no-versions")
      noversions=true;
      noheader=true; # headers do not mean anything without versions!
    ;;
    "-f" | "--filter")
      filter=$2;
      shift
      ;;
    "-d"  | "--details")
      details=1;
    ;;
    "-h" | "--h" | "-help" | "--help" | "-?" | "-syntax")
      printSyntax "${args}"
      exit 4
      ;;
    "-v" | "--v" | "-verbose" | "--verbose")
      verbose=true
      ;;
    -*)
      printError "Unknown option '$1'"
      ;;
     
    *)
      chosenRepos="$chosenRepos $1";
      ;;
  esac
  shift;
done

[[ ! -z "${ZOPEN_CA}" ]] || printError "\$ZOPEN_CA was not set. Ensure zopen init has run and \$HOME\zopen-config has been sourced."
[[ -r "${ZOPEN_CA}" ]] ||   printError "Certificate at ${ZOPEN_CA} could not be accessed. Ensure zopen init has run and \$HOME\zopen-config has been sourced. "

export SSL_CERT_FILE="${ZOPEN_CA}"
export GIT_SSL_CAINFO="${ZOPEN_CA}"
export CURL_CA_BUNDLE="${ZOPEN_CA}"

if [ ! -z "$filter" ]; then
  filter=$(echo "$filter" | awk '{print tolower($0)}')
  case "$filter" in
      blue|green|yellow|red|skipped) ;;
      *) printError "The filter must be one of blue|green|yellow|red"
  esac
fi

if ! $localoption; then

 # Retrieve all repositories
 # TODO: These are causing early exists???
 # progressHandler "network" "- Retrieved remote details" &
 # ph=$!
 # killph="kill -HUP $ph"
 # addCleanupTrapCmd "$killph"
  getReposFromGithub
  grfgRc=$?
  $killph 2>/dev/null  # if the timer is not running, the kill will fail
  [ 0 -ne $grfgRc ] && exit $grfgRc;

  # Parse repositories for zopen framework repos
  foundPort=false
  repoArray=""
  for repo in $(echo ${repo_results}); do
    repo=${repo#"ZOSOpenTools/"}
    name=${repo%port}
    printVerbose "Checking repo suffixes for '$repo' with name:'$name'"
  
    if [ -z "${chosenRepos}" ]; then
      repoArray="$repoArray $repo"
    else
      printVerbose "Testing ${chosenRepos}"
      for toolrepo in $(echo "${chosenRepos}" | tr ',' '\n'); do
        if [ "${toolrepo}" = "${repo}" ] || [ "${toolrepo}" = "${name}" ]; then
          # Skip if the repo does not end with port
          if [ "${repo}" = "${name}" ]; then
            continue;
          fi
          repoArray="$repoArray $repo"
        fi
      done
    fi
  done
fi

! $upgradeable || printDetailListEntries $details "" 1
[ -z "$remotesearch" ] || printDetailListEntries $details $needle 0
[ -z "$list" ] || printDetailListEntries $details "" 0
[ -z "$installed" ] || printInstalledEntries $details "" 0
[ -z "$whatprovides" ] || whatProvides $needle
